<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="navbar">Construction Management App — Admin</div>

  <h1>Admin Dashboard</h1>

  <!-- CREATE PROJECT -->
  <div class="card">
    <h2>Create New Project</h2>
    <input id="projectName" placeholder="Project Name (e.g., 123 Main St)">
    <input id="customerId" placeholder="Customer User ID">
    <button id="createProjectBtn">Create Project</button>
    <p id="createProjectStatus"></p>
  </div>

  <!-- QUICK DOCUMENT UPLOAD -->
  <div class="card">
    <h2>Quick Upload Document</h2>

    <input id="docProjectId" placeholder="Project ID">

    <label>Select Category:</label>
    <select id="docCategory">
      <option value="Permit">Permit</option>
      <option value="Certificate of Occupancy (CO)">Certificate of Occupancy (CO)</option>
      <option value="Architectural Plans">Architectural Plans</option>
      <option value="Survey">Survey</option>
      <option value="Insurance">Insurance</option>
      <option value="Inspection Reports">Inspection Reports</option>
      <option value="Contracts & Change Orders">Contracts & Change Orders</option>
      <option value="Engineer Reports">Engineer Reports</option>
      <option value="Zoning / Variances">Zoning / Variances</option>
      <option value="Final Walkthrough Sheet">Final Walkthrough Sheet</option>
      <option value="Final Photos">Final Photos</option>
      <option value="Closing Documents">Closing Documents</option>
      <option value="Custom">Custom</option>
    </select>

    <input id="customCategory" placeholder="Custom Category Name (if selected)">
    <input type="file" id="docFile">

    <button id="uploadDocBtn">Upload Document</button>
    <p id="docUploadStatus"></p>

    <button onclick="window.location.href='documentUpload.html'">
      Go to Full Document Manager
    </button>
  </div>

  <!-- PROJECT LIST -->
  <div class="card">
    <h2>Projects</h2>
    <div id="projectList">Loading...</div>
  </div>

  <button id="logoutBtn">Logout</button>

  <div class="page-end"></div>

  <!-- FIREBASE + APP CODE -->
  <script type="module">

    /* ----------------------------------------
       FIREBASE IMPORTS
    ---------------------------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* ----------------------------------------
       FIREBASE CONFIG
    ---------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB7GclJLT79eSM0WAYAcWSYm-VMYTbJFPk",
      authDomain: "construction-management-f48cb.firebaseapp.com",
      projectId: "construction-management-f48cb",
      storageBucket: "construction-management-f48cb.appspot.com",
      messagingSenderId: "1013804592434",
      appId: "1:1013804592434:web:79226b78462dbfbd519f2b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ----------------------------------------
       LOAD PROJECTS
    ---------------------------------------- */
    async function loadProjects() {
      const box = document.getElementById("projectList");
      box.innerHTML = "Loading...";

      try {
        const snap = await getDocs(collection(db, "projects"));

        if (snap.empty) {
          box.innerHTML = "No projects created yet.";
          return;
        }

        box.innerHTML = "";
        snap.forEach(docSnap => {
          const p = docSnap.data();

          const div = document.createElement("div");
          div.classList = "card";
          div.innerHTML = `
            <strong>${p.projectName}</strong><br>
            Project ID: ${docSnap.id}<br>
            Customer: ${p.customerId}<br>
            Status: ${p.status}<br><br>

            <button onclick="window.location.href='phases.html?projectId=${docSnap.id}'">Phases</button>
            <button onclick="window.location.href='payments.html?projectId=${docSnap.id}'">Payments</button>
            <button onclick="window.location.href='photos.html?projectId=${docSnap.id}'">Photos</button>
            <button onclick="window.location.href='documentUpload.html?projectId=${docSnap.id}'">Documents</button>
          `;

          box.appendChild(div);
        });

      } catch (error) {
        console.error("Error loading projects:", error);
        box.innerHTML = "Error loading projects.";
      }
    }

    /* ----------------------------------------
       CREATE PROJECT
    ---------------------------------------- */
    async function createProject() {
      const name = document.getElementById("projectName").value.trim();
      const customerId = document.getElementById("customerId").value.trim();

      if (!name || !customerId) {
        alert("Please enter project name and customer ID");
        return;
      }

      try {
        const docRef = await addDoc(collection(db, "projects"), {
          projectName: name,
          customerId,
          status: "in-progress",
          startDate: new Date().toISOString()
        });

        document.getElementById("createProjectStatus").innerHTML =
          `Project created! ID: ${docRef.id}`;

        loadProjects();

      } catch (err) {
        console.error("Firestore Add Error:", err);
        alert("Error creating project: " + err.message);
      }
    }

    /* ----------------------------------------
       UPLOAD DOCUMENT
    ---------------------------------------- */
    async function uploadDoc() {
      const projectId = document.getElementById("docProjectId").value.trim();
      let category = document.getElementById("docCategory").value;
      const customCat = document.getElementById("customCategory").value.trim();
      const file = document.getElementById("docFile").files[0];

      if (!projectId || !file) {
        alert("Project ID and file required.");
        return;
      }

      if (category === "Custom" && !customCat) {
        alert("Enter custom category name.");
        return;
      }

      if (category === "Custom") category = customCat;

      try {
        const path = `documents/${projectId}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, path);

        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        await addDoc(collection(db, "projects", projectId, "documents"), {
          url,
          fileName: file.name,
          category,
          uploadedBy: auth.currentUser.uid,
          timestamp: new Date().toISOString()
        });

        document.getElementById("docUploadStatus").innerHTML = "Uploaded!";
      } catch (err) {
        console.error(err);
        alert("Upload error: " + err.message);
      }
    }

    /* ----------------------------------------
       LOGOUT
    ---------------------------------------- */
    async function logout() {
      await signOut(auth);
      window.location.href = "index.html";
    }

    /* ----------------------------------------
       AUTH STATE CHECK
    ---------------------------------------- */
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      loadProjects();
    });

    /* ----------------------------------------
       EVENT LISTENERS
    ---------------------------------------- */
    document.getElementById("createProjectBtn").addEventListener("click", createProject);
    document.getElementById("uploadDocBtn").addEventListener("click", uploadDoc);
    document.getElementById("logoutBtn").addEventListener("click", logout);

  </script>

</body>
</html><!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="navbar">Construction Management App — Admin</div>

  <h1>Admin Dashboard</h1>

  <!-- CREATE PROJECT -->
  <div class="card">
    <h2>Create New Project</h2>
    <input id="projectName" placeholder="Project Name (e.g., 123 Main St)">
    <input id="customerId" placeholder="Customer User ID">
    <button id="createProjectBtn">Create Project</button>
    <p id="createProjectStatus"></p>
  </div>

  <!-- QUICK DOCUMENT UPLOAD -->
  <div class="card">
    <h2>Quick Upload Document</h2>

    <input id="docProjectId" placeholder="Project ID">

    <label>Select Category:</label>
    <select id="docCategory">
      <option value="Permit">Permit</option>
      <option value="Certificate of Occupancy (CO)">Certificate of Occupancy (CO)</option>
      <option value="Architectural Plans">Architectural Plans</option>
      <option value="Survey">Survey</option>
      <option value="Insurance">Insurance</option>
      <option value="Inspection Reports">Inspection Reports</option>
      <option value="Contracts & Change Orders">Contracts & Change Orders</option>
      <option value="Engineer Reports">Engineer Reports</option>
      <option value="Zoning / Variances">Zoning / Variances</option>
      <option value="Final Walkthrough Sheet">Final Walkthrough Sheet</option>
      <option value="Final Photos">Final Photos</option>
      <option value="Closing Documents">Closing Documents</option>
      <option value="Custom">Custom</option>
    </select>

    <input id="customCategory" placeholder="Custom Category Name (if selected)">
    <input type="file" id="docFile">

    <button id="uploadDocBtn">Upload Document</button>
    <p id="docUploadStatus"></p>

    <button onclick="window.location.href='documentUpload.html'">
      Go to Full Document Manager
    </button>
  </div>

  <!-- PROJECT LIST -->
  <div class="card">
    <h2>Projects</h2>
    <div id="projectList">Loading...</div>
  </div>

  <button id="logoutBtn">Logout</button>

  <div class="page-end"></div>

  <!-- FIREBASE + APP CODE -->
  <script type="module">

    /* ----------------------------------------
       FIREBASE IMPORTS
    ---------------------------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* ----------------------------------------
       FIREBASE CONFIG
    ---------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB7GclJLT79eSM0WAYAcWSYm-VMYTbJFPk",
      authDomain: "construction-management-f48cb.firebaseapp.com",
      projectId: "construction-management-f48cb",
      storageBucket: "construction-management-f48cb.appspot.com",
      messagingSenderId: "1013804592434",
      appId: "1:1013804592434:web:79226b78462dbfbd519f2b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ----------------------------------------
       LOAD PROJECTS
    ---------------------------------------- */
    async function loadProjects() {
      const box = document.getElementById("projectList");
      box.innerHTML = "Loading...";

      try {
        const snap = await getDocs(collection(db, "projects"));

        if (snap.empty) {
          box.innerHTML = "No projects created yet.";
          return;
        }

        box.innerHTML = "";
        snap.forEach(docSnap => {
          const p = docSnap.data();

          const div = document.createElement("div");
          div.classList = "card";
          div.innerHTML = `
            <strong>${p.projectName}</strong><br>
            Project ID: ${docSnap.id}<br>
            Customer: ${p.customerId}<br>
            Status: ${p.status}<br><br>

            <button onclick="window.location.href='phases.html?projectId=${docSnap.id}'">Phases</button>
            <button onclick="window.location.href='payments.html?projectId=${docSnap.id}'">Payments</button>
            <button onclick="window.location.href='photos.html?projectId=${docSnap.id}'">Photos</button>
            <button onclick="window.location.href='documentUpload.html?projectId=${docSnap.id}'">Documents</button>
          `;

          box.appendChild(div);
        });

      } catch (error) {
        console.error("Error loading projects:", error);
        box.innerHTML = "Error loading projects.";
      }
    }

    /* ----------------------------------------
       CREATE PROJECT
    ---------------------------------------- */
    async function createProject() {
      const name = document.getElementById("projectName").value.trim();
      const customerId = document.getElementById("customerId").value.trim();

      if (!name || !customerId) {
        alert("Please enter project name and customer ID");
        return;
      }

      try {
        const docRef = await addDoc(collection(db, "projects"), {
          projectName: name,
          customerId,
          status: "in-progress",
          startDate: new Date().toISOString()
        });

        document.getElementById("createProjectStatus").innerHTML =
          `Project created! ID: ${docRef.id}`;

        loadProjects();

      } catch (err) {
        console.error("Firestore Add Error:", err);
        alert("Error creating project: " + err.message);
      }
    }

    /* ----------------------------------------
       UPLOAD DOCUMENT
    ---------------------------------------- */
    async function uploadDoc() {
      const projectId = document.getElementById("docProjectId").value.trim();
      let category = document.getElementById("docCategory").value;
      const customCat = document.getElementById("customCategory").value.trim();
      const file = document.getElementById("docFile").files[0];

      if (!projectId || !file) {
        alert("Project ID and file required.");
        return;
      }

      if (category === "Custom" && !customCat) {
        alert("Enter custom category name.");
        return;
      }

      if (category === "Custom") category = customCat;

      try {
        const path = `documents/${projectId}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, path);

        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        await addDoc(collection(db, "projects", projectId, "documents"), {
          url,
          fileName: file.name,
          category,
          uploadedBy: auth.currentUser.uid,
          timestamp: new Date().toISOString()
        });

        document.getElementById("docUploadStatus").innerHTML = "Uploaded!";
      } catch (err) {
        console.error(err);
        alert("Upload error: " + err.message);
      }
    }

    /* ----------------------------------------
       LOGOUT
    ---------------------------------------- */
    async function logout() {
      await signOut(auth);
      window.location.href = "index.html";
    }

    /* ----------------------------------------
       AUTH STATE CHECK
    ---------------------------------------- */
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      loadProjects();
    });

    /* ----------------------------------------
       EVENT LISTENERS
    ---------------------------------------- */
    document.getElementById("createProjectBtn").addEventListener("click", createProject);
    document.getElementById("uploadDocBtn").addEventListener("click", uploadDoc);
    document.getElementById("logoutBtn").addEventListener("click", logout);

  </script>

</body>
</html>
