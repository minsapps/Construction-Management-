<script>
  // Firebase v8 CDN
  const firebaseConfig = {
    apiKey: "AIzaSyB7GclJLT79eSM0WAYAcWSYm-VMYTbJFPk",
    authDomain: "construction-management-f48cb.firebaseapp.com",
    projectId: "construction-management-f48cb",
    storageBucket: "construction-management-f48cb.appspot.com",
    messagingSenderId: "1013804592434",
    appId: "1:1013804592434:web:79226b78462dbfbd519f2b"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  /* -------- AUTH CHECK -------- */
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    loadProjects();
  });

  /* -------- LOAD PROJECTS -------- */
  async function loadProjects() {
    const container = document.getElementById("projectList");
    container.innerHTML = "";

    const snap = await db.collection("projects").get();

    if (snap.empty) {
      container.innerHTML = "No projects found.";
      return;
    }

    snap.forEach(docSnap => {
      const p = docSnap.data();
      const div = document.createElement("div");
      div.className = "card";

      div.innerHTML = `
        <strong>${p.projectName}</strong><br>
        Project ID: ${docSnap.id}<br>
        Customer: ${p.customerId}<br>
        Status: ${p.status}<br><br>

        <button onclick="window.location='phases.html?projectId=${docSnap.id}'">Phases</button>
        <button onclick="window.location='payments.html?projectId=${docSnap.id}'">Payments</button>
        <button onclick="window.location='photos.html?projectId=${docSnap.id}'">Photos</button>
        <button onclick="window.location='documentUpload.html?projectId=${docSnap.id}'">Documents</button>
      `;

      container.appendChild(div);
    });
  }

  /* -------- CREATE PROJECT -------- */
  async function createProject() {
    const name = document.getElementById("projectName").value;
    const customerId = document.getElementById("customerId").value;

    if (!name || !customerId) {
      alert("Enter project name and customer ID.");
      return;
    }

    const newDoc = await db.collection("projects").add({
      projectName: name,
      customerId,
      status: "in-progress",
      startDate: new Date().toISOString()
    });

    document.getElementById("createProjectStatus").innerText =
      `Project created! ID: ${newDoc.id}`;

    loadProjects();
  }

  /* -------- QUICK DOCUMENT UPLOAD -------- */
  async function uploadDoc() {
    const projectId = document.getElementById("docProjectId").value;
    let category = document.getElementById("docCategory").value;
    const custom = document.getElementById("customCategory").value;
    const file = document.getElementById("docFile").files[0];

    if (!projectId || !file) {
      alert("Project ID and file required.");
      return;
    }

    if (category === "Custom") {
      if (!custom) {
        alert("Enter a custom category name.");
        return;
      }
      category = custom;
    }

    const path = `documents/${projectId}/${Date.now()}_${file.name}`;
    const storageRef = storage.ref(path);

    await storageRef.put(file);
    const url = await storageRef.getDownloadURL();

    await db.collection("projects").doc(projectId)
      .collection("documents").add({
        url,
        fileName: file.name,
        category,
        uploadedBy: auth.currentUser.uid,
        timestamp: new Date().toISOString()
      });

    document.getElementById("docUploadStatus").innerText = 
      `Uploaded: ${file.name}`;
  }

  /* -------- LOGOUT -------- */
  function logout() {
    auth.signOut().then(() => {
      window.location = "index.html";
    });
  }

  /* -------- BUTTON EVENTS -------- */
  document.getElementById("createProjectBtn").addEventListener("click", createProject);
  document.getElementById("uploadDocBtn").addEventListener("click", uploadDoc);
  document.getElementById("logoutBtn").addEventListener("click", logout);
</script>
