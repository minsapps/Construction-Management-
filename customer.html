<body>
  <div class="navbar">
  Construction Management App
</div>
  <h1>Customer Dashboard</h1>

  <h2>Your Project</h2>
  <div id="projectBox">Loading...</div>

  <h2>Project Photos</h2>
  <div id="photoGallery">Loading...</div>

  <h2>Your Payments</h2>
  <div id="paymentList">Loading...</div>

  <br><br>
  <button onclick="logout()">Logout</button>

  <script type="module">
    import { signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      collection, doc, getDoc, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    async function logout() {
      await signOut(window.auth);
      window.location.href = "index.html";
    }

    let projectId = null;

    // Load customer's assigned project
    async function loadProject() {
      const user = window.auth.currentUser;

      const projectsSnap = await getDocs(
        query(
          collection(window.db, "projects"),
          where("customerId", "==", user.uid)
        )
      );

      let projectData = null;

      projectsSnap.forEach(doc => {
        projectId = doc.id;
        projectData = doc.data();
      });

      const box = document.getElementById("projectBox");

      if (!projectData) {
        box.innerHTML = "No project found.";
        return;
      }

      box.innerHTML = `
        <strong>${projectData.projectName}</strong><br>
        Status: ${projectData.status}<br>
        Start Date: ${projectData.startDate}<br>
      `;

      loadPhotos();
      loadPayments();
    }

    // Load project photos
    async function loadPhotos() {
      const gallery = document.getElementById("photoGallery");
      gallery.innerHTML = "";

      const phasesSnap = await getDocs(
        collection(window.db, "projects", projectId, "phases")
      );

      phasesSnap.forEach(async (phaseDoc) => {
        const phaseId = phaseDoc.id;

        const photosSnap = await getDocs(
          collection(window.db, "projects", projectId, "phases", phaseId, "photos")
        );

        photosSnap.forEach(photoDoc => {
          const url = photoDoc.data().url;

          const img = document.createElement("img");
          img.src = url;
          img.style.width = "120px";
          img.style.margin = "5px";
          img.style.borderRadius = "6px";
          img.style.border = "1px solid #ccc";

          gallery.appendChild(img);
        });
      });
    }

    // Load customer payments
    async function loadPayments() {
      const list = document.getElementById("paymentList");
      list.innerHTML = "";

      const paymentsSnap = await getDocs(
        collection(window.db, "projects", projectId, "payments")
      );

      paymentsSnap.forEach(doc => {
        const p = doc.data();

        const div = document.createElement("div");
        div.style.background = "#eee";
        div.style.padding = "10px";
        div.style.margin = "10px 0";
        div.style.borderRadius = "6px";

        div.innerHTML = `
          Amount: $${p.amount}<br>
          Date: ${p.date}<br>
        `;

        list.appendChild(div);
      });
    }

    loadProject();
  </script>
</body>
<div class="navbar">
  Construction Management App
</div>
