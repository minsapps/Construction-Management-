<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Contractor Management</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="navbar">
    Contractor Management
    <button id="logoutBtn" class="logoutBtn">Logout</button>
  </div>

  <h1>Assign Subcontractors</h1>

  <!-- SUB LIST -->
  <div class="card">
    <h2>Available Subcontractors</h2>
    <div id="subList">Loading...</div>
  </div>

  <!-- CREATE TASK -->
  <div class="card">
    <h2>Create Task</h2>
    <input id="taskTitle" placeholder="Task Title (e.g., Run Plumbing Rough)">
    <input id="taskProjectId" placeholder="Project ID">
    <input id="taskPhase" placeholder="Phase (optional)">
    <input id="taskDue" type="date" placeholder="Due Date">

    <label>Assign To:</label>
    <select id="subSelect"></select>

    <button id="createTaskBtn">Create Task</button>
    <p id="taskStatus"></p>
  </div>

  <script type="module">
    import { auth, db } from "./global.js";
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getDocs,
      query,
      where,
      collection,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* -------- LOGOUT -------- */
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.href = "index.html";
    };

    let userRole = "";

    /* -------- AUTH PROTECT + LOAD SUBS -------- */
    onAuthStateChanged(auth, async (user) => {
      if (!user) window.location.href = "index.html";

      const snap = await getDocs(
        query(collection(db, "users"), where("role", "==", "subcontractor"))
      );

      const subListDiv = document.getElementById("subList");
      const subSelect = document.getElementById("subSelect");
      subListDiv.innerHTML = "";

      snap.forEach(docSnap => {
        const sub = docSnap.data();
        const div = document.createElement("div");
        div.className = "innerCard";

        div.innerHTML = `
          <strong>${sub.name}</strong><br>
          ${sub.email}<br>
          ID: ${docSnap.id}<br>
        `;

        subListDiv.appendChild(div);

        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.innerHTML = `${sub.name} (${sub.email})`;
        subSelect.appendChild(opt);
      });
    });

    /* -------- CREATE TASK -------- */
    document.getElementById("createTaskBtn").onclick = async () => {
      const title = document.getElementById("taskTitle").value;
      const projectId = document.getElementById("taskProjectId").value;
      const phase = document.getElementById("taskPhase").value;
      const due = document.getElementById("taskDue").value;
      const assignedTo = document.getElementById("subSelect").value;

      if (!title || !projectId || !assignedTo) return alert("Missing fields!");

      await addDoc(collection(db, "tasks"), {
        title,
        projectId,
        phase,
        due,
        assignedTo,
        status: "pending",
        created: new Date().toISOString()
      });

      document.getElementById("taskStatus").innerHTML = "Task Created!";
    };
  </script>

</body>
</html>
