<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Project Phases</title>

  <!-- Construction Theme -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
    }

    .navbar {
      background: #003366; /* Dark Blue */
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      letter-spacing: 1px;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
    }

    /* Progress Bar */
    .progress-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    .progress-label {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .progress-bar {
      width: 100%;
      background: #ddd;
      border-radius: 20px;
      height: 25px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: #FFC107; /* Yellow from logo */
      transition: 0.5s;
    }

    /* Add Phase Panel */
    .panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    .panel h2 {
      margin-top: 0;
    }

    .panel input, .panel select, .panel button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .panel button {
      background: #003366;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    /* Phase Cards */
    .phase-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 6px solid #FFC107;
    }

    .phase-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #222;
    }

    .status {
      font-size: 14px;
      font-weight: bold;
      display: inline-block;
      padding: 5px 10px;
      border-radius: 6px;
      color: white;
    }

    .pending { background: #999; }
    .in-progress { background: #003366; }
    .complete { background: #28a745; }

    .btn-small {
      margin-top: 10px;
      background: #FFC107;
      color: black;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-small:hover {
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="navbar">Project Phases</div>

  <div class="container">
    <!-- PROGRESS BAR -->
    <div class="progress-box">
      <div class="progress-label">Overall Progress</div>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>

    <!-- ADD / UPDATE PHASE -->
    <div class="panel">
      <h2>Add / Update Phase</h2>
      <input id="phaseName" placeholder="Phase Name (ex: Demolition)">
      
      <select id="phaseStatus">
        <option value="pending">Pending</option>
        <option value="in-progress">In Progress</option>
        <option value="complete">Complete</option>
      </select>

      <button onclick="addOrUpdatePhase()">Save Phase</button>
    </div>

    <!-- LIST OF PHASES -->
    <div id="phaseList"></div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7GclJLT79eSM0WAYAcWSYm-VMYTbJFPk",
      authDomain: "construction-management-f48cb.firebaseapp.com",
      projectId: "construction-management-f48cb",
      storageBucket: "construction-management-f48cb.appspot.com",
      messagingSenderId: "1013804592434",
      appId: "1:1013804592434:web:79226b78462dbfbd519f2b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get projectId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get("projectId");

    async function loadPhases() {
      const listBox = document.getElementById("phaseList");
      listBox.innerHTML = "";

      const snap = await getDocs(collection(db, "projects", projectId, "phases"));

      let total = 0;
      let completed = 0;

      snap.forEach(docSnap => {
        total++;
        const phase = docSnap.data();
        if (phase.status === "complete") completed++;

        const card = document.createElement("div");
        card.className = "phase-card";

        card.innerHTML = `
          <div class="phase-header">${phase.name}</div>
          <span class="status ${phase.status}">
            ${phase.status.replace("-", " ").toUpperCase()}
          </span><br>
          <button class="btn-small" onclick="prefill('${docSnap.id}', '${phase.name}', '${phase.status}')">
            Edit Phase
          </button>
        `;

        listBox.appendChild(card);
      });

      // Update progress
      if (total > 0) {
        const percent = Math.round((completed / total) * 100);
        document.getElementById("progressFill").style.width = percent + "%";
      }
    }

    function prefill(id, name, status) {
      window.editId = id;
      document.getElementById("phaseName").value = name;
      document.getElementById("phaseStatus").value = status;
    }

    async function addOrUpdatePhase() {
      const name = document.getElementById("phaseName").value;
      const status = document.getElementById("phaseStatus").value;

      if (!name) return alert("Enter a phase name!");

      const id = window.editId || name.replace(/\s+/g, "_");

      await setDoc(doc(db, "projects", projectId, "phases", id), {
        name,
        status
      });

      window.editId = null;
      document.getElementById("phaseName").value = "";
      loadPhases();
    }

    loadPhases();
  </script>

</body>
</html>
