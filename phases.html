<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Project Phases</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <a href="admin.html">Dashboard</a>
    <a href="phases.html">Phases</a>
    <a href="payments.html">Payments</a>
    <a href="photos.html">Photos</a>
    <a href="documentUpload.html">Documents</a>
    <a href="#" id="logoutBtn">Logout</a>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <h1 id="projectName">PHASES</h1>

    <div class="card">
      <h2>Add / Update Phase</h2>

      <label>Phase Name</label>
      <input id="phaseName" placeholder="e.g., Framing, Plumbing, Roofing">

      <label>Phase Status</label>
      <select id="phaseStatus">
        <option value="pending">Pending</option>
        <option value="in-progress">In Progress</option>
        <option value="complete">Complete</option>
      </select>

      <button id="savePhaseBtn">Add / Update Phase</button>
      <p id="phaseStatusText"></p>
    </div>

    <hr>

    <h2>Existing Phases</h2>
    <div id="phaseList">Loading...</div>

  </div> <!-- end main-content -->

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    import {
      getAuth,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      doc,
      collection,
      addDoc,
      getDocs,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* FIREBASE */
    const firebaseConfig = {
      apiKey: "AIzaSyB7GclJLT79eSM0WAYAcWSYm-VMYTbJFPk",
      authDomain: "construction-management-f48cb.firebaseapp.com",
      projectId: "construction-management-f48cb",
      storageBucket: "construction-management-f48cb.appspot.com",
      messagingSenderId: "1013804592434",
      appId: "1:1013804592434:web:79226b78462dbfbd519f2b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* GET PROJECT ID FROM URL */
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get("projectId");
    document.getElementById("projectName").innerText = "PHASES â€” " + projectId;

    /* LOAD PHASES */
    async function loadPhases() {
      const list = document.getElementById("phaseList");
      list.innerHTML = "";

      const snap = await getDocs(collection(db, "projects", projectId, "phases"));

      if (snap.empty) {
        list.innerHTML = "No phases yet.";
        return;
      }

      snap.forEach(docSnap => {
        const p = docSnap.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>${p.name}</strong><br>
          Status: ${p.status}<br>
          <button onclick="editPhase('${docSnap.id}', '${p.name}', '${p.status}')">Edit</button>
        `;
        list.appendChild(div);
      });
    }

    window.editPhase = function (id, name, status) {
      document.getElementById("phaseName").value = name;
      document.getElementById("phaseStatus").value = status;
      document.getElementById("savePhaseBtn").setAttribute("data-id", id);
    };

    /* SAVE PHASE */
    document.getElementById("savePhaseBtn").addEventListener("click", async () => {
      const name = document.getElementById("phaseName").value;
      const status = document.getElementById("phaseStatus").value;
      const existingId = document.getElementById("savePhaseBtn").getAttribute("data-id");

      if (!name) {
        alert("Enter phase name.");
        return;
      }

      if (existingId) {
        await updateDoc(doc(db, "projects", projectId, "phases", existingId), {
          name,
          status
        });
      } else {
        await addDoc(collection(db, "projects", projectId, "phases"), {
          name,
          status
        });
      }

      document.getElementById("phaseStatusText").innerText = "Saved!";
      loadPhases();
    });

    /* LOGOUT */
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    /* AUTH CHECK */
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = "index.html";
      else loadPhases();
    });
  </script>

</body>
</html>
